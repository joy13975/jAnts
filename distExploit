#!/bin/bash

echo "Scanning for hosts..."
free_hosts=$(scanFreeHosts jants)
n_free_hosts=$(echo "${free_hosts[@]}" | wc -w)
echo "There are $n_free_hosts jants-free hosts:"
echo ${free_hosts[@]}

echo "Use first N machines: "
read maxMachines
if [[ $maxMachines -gt $n_free_hosts ]]; then
    maxMachines=$n_free_hosts
fi
params=$(cat goodParams.txt)

free_hosts=( $free_hosts )
for ((i=0;i<$maxMachines;i++)); do
    host=${free_hosts[$i]}
    randSeed=$((1 + RANDOM % 1337))

    screenJob="./jants $params -rs $randSeed -o distOutputs/$host.txt > distOutputs/$host.log"
#    echo "Screen Job is $screenJob"
    sshJob="cd src/jAnts; screen -dm bash -c"
#    echo "SSH Job is $sshJob"
    cmd="goto $host ""'""$sshJob ""''"'"'"''""$screenJob""''"'"'"'"
#    echo Command is: "$cmd"

    echo "Sending job to $host"
    eval $cmd
done
